var Cleanser=(function(){var a={trace:false,stepDelay:200,applicationID:null,cookies:{clear:true,exclude:["user"]},ls:{clear:true,exclude:["lastManifestGuid","applicationID","phonegapPresent","shellType"]},sql:{clearRows:true,dropTables:false,dbname:"mDesign",dbver:"1.0",dbdesc:"Dummy Description",tables:["subject","attachment","expandDB"]},idb:{clearStores:true,deleteDB:true,dbname:"mDesign",dbvermin:15,dbvermax:35},fs:{clear:true}};var f=[];function d(){function p(){if(f.length>0){f.pop()()}else{b.oncompleted()}}window.setTimeout(p,a.stepDelay)}function c(p){b.setStatus(p)}function o(p){c("*** "+p)}function g(p){if(a.trace){c(p)}}function j(){function p(){function s(){function t(v){function u(x){function w(B,D){function A(F,G){function H(K,L){g("table '"+v+"' dropped");s()}function J(K,L){}g("rows cleared in '"+v+"'");if(a.sql.dropTables){var I="DROP TABLE IF EXISTS "+v;F.executeSql(I,undefined,H,J)}else{s()}}function C(F,G){o("could not delete rows for "+v);s()}if(D.rows.length>0){var E="DELETE FROM '"+v+"'";B.executeSql(E,undefined,A,C)}else{g("table '"+v+"' does not exist - skipping");s()}}function z(A,B){o("could not validate table existence for "+v);s()}var y="SELECT name FROM sqlite_master WHERE type='table' AND name='"+v+"'";x.executeSql(y,undefined,w,z)}g("Clearing table '"+v+"' ...");if(a.sql.clearRows){q.transaction(u)}else{}}if(r.length>0){t(r.pop())}else{c("Sql storage cleared.");d()}}var r=a.sql.tables.slice();var q=openDatabase("mDesign","","Dummy Description",1024*1024);g("opened sql db");s()}if(typeof(window.openDatabase)==="function"){c("Clearing sql storage ...");p()}else{c("Sql api does not exist - skipping");d()}}function h(){if(window.indexedDB){function p(){function t(x){function y(z){}g("onupgradeneeded - creating test data");y(x.target.result)}function s(x){function D(H){o("iDB DB error: "+H.target.errorCode);doNextStage()}function A(){G.close();q()}function E(H){c("IndexedDB storage cleared.");A()}function y(H){o("iDB Tx error"+H.target.errorCode);A()}function C(H){if(a.trace){g("--- object stores: ---");for(var I=0;I<H.length;I++){g(H.item(I))}g("---------------------")}}function B(K,I){function M(){g(H+" cleared");B(++K,I)}if(K>=I.length){g("no more stores to purge!")}else{var H=I.item(K);var J;try{J=z.objectStore(H)}catch(N){SetErrorStatus("iDB error: "+N.name+" caught");A()}var L=J.clear();L.onsuccess=M}}g("Version "+v+" of database opened ok");var G=u.result;var F=G.objectStoreNames;if(F.length==0){A()}else{C(F);G.onerror=D;var z=G.transaction(F,"readwrite");z.oncomplete=E;z.onerror=y;B(0,F)}}function r(x){if(u.error.name=="VersionError"&&++v<=a.idb.dbvermax){w()}else{o("IndexedDB open failed: "+u.error.name);d()}}function w(){u=window.indexedDB.open(a.idb.dbname,v);u.onerror=r;u.onsuccess=s;u.onupgradeneeded=t}c("Clearing indexedDB storage ...");var v=a.idb.dbvermin;var u;w()}function q(){function r(){c("IndexedDB database deleted");d()}function t(){o("IndexedDB deleteDatabase failure");d()}if(a.idb.deleteDB){if(typeof(window.indexedDB.deleteDatabase)==="function"){c("Deleting indexedDB database");var s=window.indexedDB.deleteDatabase(a.idb.dbname);s.onerror=t;s.onsuccess=r}else{o("IndexedDB api has no deleteDataba");d()}}else{d()}}if(a.idb.clearStores){p()}else{q()}}else{c("IndexedDB api not found - skipping");d()}}function m(){function t(){c("File system cleared");d()}function q(u){o("Failed to clear file system - error "+u.code);d()}function s(u){c("Clearing file system...");u.removeRecursively(t,q)}function p(u){if(a.applicationID){u.root.getDirectory("mDesign/"+a.applicationID,{create:false},s,t)}else{c("File system not used - skipping");d()}}function r(){o("File system not available - skipping");d()}window.requestFileSystem(LocalFileSystem.PERSISTENT,0,p,r)}function e(){function p(){var q=[];for(var r=0;r<localStorage.length;++r){if(a.ls.exclude.indexOf(localStorage.key(r))==-1){q.push(localStorage.key(r))}}for(var r=0;r<q.length;++r){localStorage.removeItem(q[r])}}c("Clearing local storage ...");p();c("Local storage cleared.");d()}function n(){function p(){var s,t,r,u,q;t=document.cookie.split(";");for(r=0;r<t.length;r++){s=t[r];u=s.indexOf("=");q=u>-1?s.substr(0,u):s;while(q.substring(0,1)===" "){q=q.substring(1,q.length)}if(a.cookies.exclude.indexOf(q)==-1){document.cookie=q+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/"}}}c("Clearing cookies ...");p();c("Cookies cleared");d()}function i(){g("in clear()");if(a.idb.clearStores||a.idb.deleteDB){f.push(h)}if(a.sql.clearRows||a.sql.dropTables){f.push(j)}if(a.fs.clear){f.push(m)}if(a.ls.clear){f.push(e)}if(a.cookies.clear){f.push(n)}d()}function l(){}function k(p){}var b={clear:i,setApplicationID:function(p){a.applicationID=p},disableClearCookies:function(){a.cookies.clear=false},disableClearLocalStorage:function(){a.ls.clear=false},disableClearWebSql:function(){a.sql.clearRows=false;dropTables=false},disableClearIndexedDB:function(){a.idb.clearStores=false;a.idb.deleteDB=false},disableClearFileSystem:function(){a.fs.clear=false},includeLocalStorageKey:function(q){var p=a.ls.exclude.indexOf(q);if(p>-1){a.ls.exclude.splice(p,1)}},oncompleted:l,setStatus:k};return b})();